<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUT Swipe - The Player Tinder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg" href="https://www.logo.wine/a/logo/Tinder_(app)/Tinder_(app)-Flame-Logo.wine.svg">

    <style>
        /* --- CSS Styles --- */
        :root {
            --primary-pink: #EB106A;
            --secondary-red: #F05550;
            --card-background: #1a1a1a;
            --text-color: #f0f0f0;
            --like-color: #28a745;
            --dislike-color: #dc3545;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            background: linear-gradient(to right, var(--primary-pink), var(--secondary-red));
            background-size: 100% 100%;
            background-attachment: fixed;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh; 
            height: 100vh; 
            overflow: hidden; 
            position: relative;
            user-select: none; 
            
            width: 100%;
            max-width: 100%;
            max-height: 100%;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 2.5em;
            text-align: center;
            z-index: 10;
        }

        #swipeCounterTop {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            z-index: 5;
        }

        /* Styles for level display */
        #levelDisplay {
            text-align: center; 
            margin-bottom: 20px; /* Reduce space to bring everything closer */
            font-weight: bold; 
            color: white;
            z-index: 5;
            width: 90%;
            max-width: 380px;
        }

        #levelDisplay #currentLevel {
            font-size: 1.8em;
            color: #ffde59;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        #levelDisplay #xpBarContainer {
            background-color: #333; 
            height: 12px; 
            width: 80%; 
            margin: 5px auto; 
            border-radius: 6px; 
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }
        
        #levelDisplay #xpBar {
            height: 100%; 
            width: 0%; 
            background-color: #00ff00; 
            border-radius: 6px;
            transition: width 0.3s ease-out, background-color 0.3s ease-out;
        }

        #levelDisplay #xpProgress {
            font-size: 0.9em;
            color: #ccc;
        }


        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 380px;
            perspective: 1000px;
            margin-top: 0;
            margin-left: auto;
            margin-right: auto;
            flex-grow: 1; 
            min-height: 0; 
        }

        .card-stack {
            position: relative;
            width: 100%;
            height: 520px; 
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; 
        }

        /* Main card styles */
        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: var(--card-background);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            overflow: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            cursor: grab;
            will-change: transform, opacity;
            top: 0;
            left: 0;
            margin-left: auto;
            margin-right: auto;
            right: 0;
        }

        .card-image {
            width: 100%;
            height: 70%; 
            object-fit: contain; 
            border-radius: 20px 20px 0 0; 
            transform: none; 
            transition: none; 
        }

        .card-info {
            display: flex; 
            padding: 15px;
            text-align: center;
            flex-grow: 1;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .card-info .player-name {
            margin: 5px 0;
            font-size: 1.8em;
            font-weight: 700;
            color: #ffde59;
        }

        .card-info .player-ovr {
            margin: 2px 0;
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
        }

        .card-info .card-type {
            margin: 2px 0;
            font-size: 0.9em;
            color: #ccc;
        }

        .swipe-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            padding: 10px 20px;
            font-size: 3em;
            font-weight: bold;
            border-radius: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 1000;
        }

        .swipe-message.like {
            color: var(--like-color);
            border: 3px solid var(--like-color);
            transform: translate(-50%, -50%) rotate(-45deg) scale(0.8);
        }

        .swipe-message.nope {
            color: var(--dislike-color);
            border: 3px solid var(--dislike-color);
            transform: translate(-50%, -50%) rotate(45deg) scale(0.8);
        }

        .swipe-message.visible {
            opacity: 1;
            transform: translate(-50%, -50%) rotate(0deg) scale(1);
        }

        .controls {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            flex-shrink: 0; 
        }

        .control-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            color: var(--text-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-button.dislike {
            color: var(--dislike-color);
            border: 2px solid var(--dislike-color);
        }

        .control-button.like {
            color: var(--like-color);
            border: 2px solid var(--like-color);
        }

        .control-button:active {
            transform: scale(0.95);
        }

        /* Burger Menu and new action buttons */
        .menu-action-button {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(128, 128, 128, 0.5);
            border: none;
            color: white;
            font-size: 1.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .menu-action-button:hover {
            background-color: rgba(128, 128, 128, 0.7);
            transform: translateY(-1px);
        }

        .menu-action-button:active {
            transform: scale(0.95);
        }

        #burgerMenuBtn {
            top: 20px;
            left: 20px;
        }

        #exportStatsBtn {
            top: 20px; 
            right: 20px;
            left: auto;
            font-size: 1.5em; /* Icon size adjustment */
        }

        #importStatsBtn {
            top: 80px; 
            right: 20px;
            left: auto;
            font-size: 1.5em; /* Icon size adjustment */
        }

        #refreshSeriesBtn { /* New button */
            top: 140px; 
            right: 20px;
            left: auto;
            font-size: 1.5em; /* Icon size adjustment */
        }

        #languageToggleBtn { /* New language toggle button */
            top: 200px;
            right: 20px;
            left: auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(128, 128, 128, 0.5);
            border: none;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease, transform 0.1s ease;
            padding: 0; /* Remove padding to fit image */
            overflow: hidden; /* Hide overflow for image */
        }

        #languageToggleBtn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        #languageToggleBtn:hover {
            background-color: rgba(128, 128, 128, 0.7);
            transform: translateY(-1px);
        }

        #languageToggleBtn:active {
            transform: scale(0.95);
        }


        #sideMenu {
            position: fixed;
            top: 0;
            left: -300px; 
            width: 280px;
            height: 100%;
            background-color: var(--card-background);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1500;
            transition: left 0.3s ease-out;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #sideMenu.open {
            left: 0;
        }

        #sideMenu .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            color: var(--text-color);
            font-size: 2em;
            cursor: pointer;
            transition: color 0.2s;
        }

        #sideMenu .close-btn:hover {
            color: var(--secondary-red);
        }

        #sideMenu ul {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        #sideMenu ul li {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #sideMenu ul li:last-child {
            border-bottom: none;
        }

        #sideMenu ul li a, #sideMenu ul li button {
            color: var(--text-color);
            text-decoration: none;
            font-size: 1.2em;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: color 0.2s;
        }

        #sideMenu ul li a:hover, #sideMenu ul li button:hover {
            color: var(--primary-pink);
        }

        /* Series selection modal (now for settings) */
        #seriesSelectionModal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .series-modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center;
            animation: bounceIn 0.5s ease-out;
            position: relative;
        }

        .series-modal-content h2 {
            color: var(--secondary-red);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .series-options {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .series-options label {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .series-options input[type="range"] {
            width: 80%;
            -webkit-appearance: none;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .series-options input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-pink);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .series-options input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-pink);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .series-options #sliderValue {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-pink);
            margin-top: -10px;
            margin-bottom: 15px;
        }

        .series-options button#applySeriesLengthBtn {
            background-color: var(--primary-pink);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-top: 15px;
        }
        .series-options button#applySeriesLengthBtn:hover {
            background-color: #d10e5d;
            transform: translateY(-2px);
        }
        .series-options button#applySeriesLengthBtn:active {
            transform: scale(0.98);
        }

        .series-modal-close-btn {
            color: var(--text-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .series-modal-close-btn:hover,
        .series-modal-close-btn:focus {
            color: var(--secondary-red);
            text-decoration: none;
            cursor: pointer;
        }

        /* Card Preset Modal - Updated styles for multiple selection */
        #presetSelectionModal {
            display: none;
            position: fixed;
            z-index: 10002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .preset-modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center;
            animation: bounceIn 0.5s ease-out;
            position: relative;
            max-height: 100vh;
            overflow-y: hidden; /* Keep scroll on internal grid */
        }

        .preset-modal-content h2 {
            color: var(--secondary-red);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .preset-options-grid { /* New grid for preset options */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
            max-height: 400px; /* Limit height for scrolling */
            overflow-y: auto;
            padding-right: 5px; /* For scrollbar */
        }

        .preset-option-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease, transform 0.1s ease, border-color 0.2s ease;
        }

        .preset-option-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .preset-option-item.selected { /* Style for selected elements */
            background-color: var(--primary-pink);
            border-color: var(--primary-pink);
            box-shadow: 0 0 10px rgba(235, 16, 106, 0.5);
        }
        .preset-option-item input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            accent-color: var(--secondary-red); /* Checkbox style */
            cursor: pointer;
        }
        .preset-option-item label {
            flex-grow: 1;
            text-align: left;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preset-option-item .card-count {
            font-size: 0.9em;
            color: #bbb;
            background-color: rgba(0,0,0,0.2);
            padding: 3px 8px;
            border-radius: 5px;
            margin-left: 10px;
        }

        button#applyPresetFilterBtn { /* New apply button */
            background-color: var(--primary-pink);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-top: 25px; /* Space above */
        }
        button#applyPresetFilterBtn:hover {
            background-color: #d10e5d;
            transform: translateY(-2px);
        }
        button#applyPresetFilterBtn:active {
            transform: scale(0.98);
        }


        .preset-modal-close-btn {
            color: var(--text-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .preset-modal-close-btn:hover,
        .preset-modal-close-btn:focus {
            color: var(--secondary-red);
            text-decoration: none;
            cursor: pointer;
        }

        /* OVR Selection Modal */
        #ovrSelectionModal {
            display: none;
            position: fixed;
            z-index: 10003;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .ovr-modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center;
            animation: bounceIn 0.5s ease-out;
            position: relative;
        }

        .ovr-modal-content h2 {
            color: var(--secondary-red);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .ovr-options {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ovr-options label {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .ovr-options .slider-group {
            width: 80%;
            margin-bottom: 20px;
        }

        .ovr-options input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: linear-gradient(to right, var(--primary-pink) 0%, var(--secondary-red) 100%);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .ovr-options input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            border: 2px solid var(--primary-pink);
        }

        .ovr-options input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            border: 2px solid var(--primary-pink);
        }

        .ovr-options #ovrRangeValue {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-pink);
            margin-bottom: 15px;
        }

        .ovr-options button#applyOvrFilterBtn {
            background-color: var(--primary-pink);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-top: 15px;
        }
        .ovr-options button#applyOvrFilterBtn:hover {
            background-color: #d10e5d;
            transform: translateY(-2px);
        }
        .ovr-options button#applyOvrFilterBtn:active {
            transform: scale(0.98);
        }

        .ovr-modal-close-btn {
            color: var(--text-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .ovr-modal-close-btn:hover,
        .ovr-modal-close-btn:focus {
            color: var(--secondary-red);
            text-decoration: none;
            cursor: pointer;
        }

        /* Modal for final team (Collection) */
        #teamModal, #collectionModal { /* Apply same base styles for full-screen modals */
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 20px;
            width: 90vw;
            height: 90vh;
            max-width: 950px;
            max-height: 800px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            text-align: center;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-content h2 {
            color: var(--secondary-red);
            margin-bottom: 20px;
            font-size: 2.2em;
            flex-shrink: 0;
        }

        #teamOverallRating, #collectionCount {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffde59;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .team-grid, .collection-grid { /* Apply same grid styles */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 0;
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            padding-bottom: 10px;
            justify-items: center;
        }

        .team-player-card { /* Used for cards in collection modal too */
            background-color: transparent;
            border-radius: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            box-shadow: none;
            width: 100%;
            max-width: 150px;
            position: relative;
            transition: transform 0.2s ease;
        }

        .team-player-card:hover {
            transform: translateY(-5px);
        }

        .team-player-card img {
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 0;
            border: none;
            display: block;
        }

        .team-player-card .player-details {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            font-size: 0.8em;
            line-height: 1.2;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            padding-top: 30px;
            padding-bottom: 5px;
        }
        .team-player-card .player-details p {
            margin: 0;
        }
        .team-player-card .player-details .player-ovr {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffde59;
        }
        .team-player-card .player-details .player-name-modal {
            font-size: 1.1em;
            font-weight: 600;
        }
        .team-player-card .player-details .card-type-modal {
            font-size: 0.7em;
            opacity: 0.8;
        }


        .close-button {
            color: var(--text-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--secondary-red);
            text-decoration: none;
            cursor: pointer;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% {
                opacity: 0;
                transform: scale3d(.3, .3, .3);
            }
            20% {
                transform: scale3d(1.1, 1.1, 1.1);
            }
            40% {
                transform: scale3d(.9, .9, .9);
            }
            60% {
                opacity: 1;
                transform: scale3d(1.03, 1.03, 1.03);
            }
            80% {
                transform: scale3d(.97, .97, .97);
            }
            100% {
                opacity: 1;
                transform: scale3d(1, 1, 1);
            }
        }
    </style>
</head>
<body>
    <button id="burgerMenuBtn" class="menu-action-button">☰</button>
    <button id="exportStatsBtn" class="menu-action-button">💾</button>
    <button id="importStatsBtn" class="menu-action-button">⬆️</button>
    <button id="refreshSeriesBtn" class="menu-action-button">🔄</button>
    <button id="languageToggleBtn" class="menu-action-button">
        <img id="languageFlag" src="https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/UK.png" alt="Language Flag">
    </button>

    <div class="swipe-message like" id="likeMessage">LIKE</div>
    <div class="swipe-message nope" id="nopeMessage">NOPE</div>

    <h1 id="mainTitle">FUT Swipe</h1>
    
    <div id="levelDisplay">
        <span id="levelText">Level</span>: <span id="currentLevel">1</span>
        <div id="xpBarContainer">
            <div id="xpBar"></div>
        </div>
        <span id="xpProgress">0 / 100 XP</span>
    </div>
    <div id="swipeCounterTop">0 / 0</div>

    <div class="container">
        <div class="card-stack" id="cardStack">
            </div>
        <div class="controls">
            <button class="control-button dislike" id="dislikeBtn">👎</button>
            <button class="control-button like" id="likeBtn">👍</button>
        </div>
        <p id="swipeCount" style="display:none;">Swipes: 0 / 100</p>
    </div>

    <div id="sideMenu">
        <span class="close-btn">&times;</span>
        <ul>
            <li><button id="resetGameMenuBtn">New Game</button></li>
            <li><button id="viewTeamMenuBtn">View Team</button></li>
            <li><button id="viewCollectionMenuBtn">My Collection</button></li> 
            <li><button id="changeSeriesLengthBtn">Change Series Length</button></li>
            <li><button id="choosePresetBtn">Choose Preset</button></li>
            <li><button id="filterByOVRBtn">Filter by OVR</button></li>
        </ul>
    </div>

    <div id="seriesSelectionModal">
        <div class="series-modal-content">
            <span class="close-button series-modal-close-btn">&times;</span>
            <h2 id="adjustSeriesLengthTitle">Adjust Series Length</h2>
            <div class="series-options">
                <label for="seriesRange" id="numberOfSwipesLabel">Number of swipes :</label>
                <input type="range" id="seriesRange" min="10" max="100" step="40" value="50">
                <span id="sliderValue">50</span>
                <button id="applySeriesLengthBtn">Apply & Restart</button>
            </div>
        </div>
    </div>

    <div id="presetSelectionModal">
        <div class="preset-modal-content">
            <span class="close-button preset-modal-close-btn">&times;</span>
            <h2 id="chooseCardTypeTitle">Choose one or more card types</h2>
            <div id="presetOptions" class="preset-options-grid"> 
                </div>
            <button id="applyPresetFilterBtn">Apply Selection</button>
        </div>
    </div>

    <div id="ovrSelectionModal">
        <div class="ovr-modal-content">
            <span class="close-button ovr-modal-close-btn">&times;</span>
            <h2 id="filterByOVRTitle">Filter by OVR</h2>
            <div class="ovr-options">
                <label for="ovrMinRange" id="minRatingLabel">Minimum Rating :</label>
                <div class="slider-group">
                    <input type="range" id="ovrMinRange" min="64" max="99" value="64">
                    <label for="ovrMaxRange" id="maxRatingLabel">Maximum Rating :</label>
                    <input type="range" id="ovrMaxRange" min="64" max="99" value="99">
                </div>
                <span id="ovrRangeValue">64 - 99</span>
                <button id="applyOvrFilterBtn">Apply & Restart</button>
            </div>
        </div>
    </div>


    <div id="teamModal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="dreamTeamTitle">Your Dream Team! ⚽</h2>
            <div id="teamOverallRating">Team Overall Rating: -</div>
            <div id="teamGrid" class="team-grid">
                </div>
            <p style="margin-top: auto; font-size: 0.9em; color: #aaa; padding-top: 10px;" id="teamModalFooter">
                Click on a player to see more details (feature coming soon).
            </p>
        </div>
    </div>

    <div id="collectionModal">
        <div class="modal-content">
            <span class="close-button" id="closeCollectionModalBtn">&times;</span>
            <h2 id="myCollectionTitle">My Collection 🏆</h2>
            <div id="collectionCount">Total cards in collection: 0</div>
            <div id="collectionGrid" class="collection-grid">
                </div>
        </div>
    </div>

    <script>
        // --- JavaScript ---
        const cardStack = document.getElementById('cardStack');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const likeBtn = document.getElementById('likeBtn');
        const swipeCounterTop = document.getElementById('swipeCounterTop');
        const likeMessage = document.getElementById('likeMessage');
        const nopeMessage = document.getElementById('nopeMessage');

        // Existing Modals
        const teamModal = document.getElementById('teamModal');
        const teamGrid = document.getElementById('teamGrid');
        const teamOverallRating = document.getElementById('teamOverallRating');
        const closeTeamModalBtn = teamModal.querySelector('.close-button');

        const seriesSelectionModal = document.getElementById('seriesSelectionModal');
        const seriesRange = document.getElementById('seriesRange');
        const sliderValueDisplay = document.getElementById('sliderValue');
        const applySeriesLengthBtn = document.getElementById('applySeriesLengthBtn');
        const closeSeriesModalBtn = seriesSelectionModal.querySelector('.series-modal-close-btn');

        const presetSelectionModal = document.getElementById('presetSelectionModal');
        const presetOptionsDiv = document.getElementById('presetOptions'); // New container for preset options
        const applyPresetFilterBtn = document.getElementById('applyPresetFilterBtn'); // New apply button
        const closePresetModalBtn = presetSelectionModal.querySelector('.preset-modal-close-btn');

        const ovrSelectionModal = document.getElementById('ovrSelectionModal');
        const ovrMinRange = document.getElementById('ovrMinRange');
        const ovrMaxRange = document.getElementById('ovrMaxRange');
        const ovrRangeValue = document.getElementById('ovrRangeValue');
        const applyOvrFilterBtn = document.getElementById('applyOvrFilterBtn');
        const closeOvrModalBtn = ovrSelectionModal.querySelector('.ovr-modal-close-btn');

        // New elements for collection
        const collectionModal = document.getElementById('collectionModal');
        const collectionGrid = document.getElementById('collectionGrid');
        const collectionCountDisplay = document.getElementById('collectionCount');
        const closeCollectionModalBtn = document.getElementById('closeCollectionModalBtn');


        // Burger Menu Elements
        const burgerMenuBtn = document.getElementById('burgerMenuBtn');
        const sideMenu = document.getElementById('sideMenu');
        const closeSideMenuBtn = sideMenu.querySelector('.close-btn');
        const resetGameMenuBtn = document.getElementById('resetGameMenuBtn');
        const viewTeamMenuBtn = document.getElementById('viewTeamMenuBtn');
        const viewCollectionMenuBtn = document.getElementById('viewCollectionMenuBtn'); 
        const changeSeriesLengthBtn = document.getElementById('changeSeriesLengthBtn');
        const choosePresetBtn = document.getElementById('choosePresetBtn');
        const filterByOVRBtn = document.getElementById('filterByOVRBtn');

        // New export/import/refresh buttons
        const exportStatsBtn = document.getElementById('exportStatsBtn');
        const importStatsBtn = document.getElementById('importStatsBtn');
        const refreshSeriesBtn = document.getElementById('refreshSeriesBtn');

        // Language toggle button
        const languageToggleBtn = document.getElementById('languageToggleBtn');
        const languageFlag = document.getElementById('languageFlag');

        let allPlayersData = [];
        let cardTypesCount = {};
        let currentSessionPlayers = [];
        let likedPlayersInSession = []; 
        let permanentCollection = []; 
        let currentPlayerIndex = 0;
        let swipeCounter = 0;
        let MAX_SWIPES_PER_SESSION = 50;
        let availableCardTypes = [];
        let selectedCardPresets = ['all']; // Changed to array for multiple selection
        let ovrFilterMin = 64;
        let ovrFilterMax = 99;
        let maxOVRFound = 99;

        // --- Variables and Functions for Level System ---
        let userLevel = 1;
        let currentXP = 0;
        const MAX_LEVEL = 100;

        // Function to calculate XP needed for next level
        function getXPForNextLevel(level) {
            if (level >= MAX_LEVEL) {
                return Infinity; // No XP needed beyond max level
            }
            // Adjusted formula for faster progression
            return Math.floor(50 + (level * level * 0.8));
        }

        // Reference DOM elements for level display
        const currentLevelSpan = document.getElementById('currentLevel');
        const xpBar = document.getElementById('xpBar');
        const xpProgressSpan = document.getElementById('xpProgress');

        // Function to add XP and check for level up
        function addXP(amount) {
            currentXP += amount;
            console.log(`XP gained: +${amount}. Total XP: ${currentXP}`);

            let xpNeeded = getXPForNextLevel(userLevel);

            while (currentXP >= xpNeeded && userLevel < MAX_LEVEL) {
                currentXP -= xpNeeded; 
                userLevel++; 
                console.log(`Congratulations! You reached Level ${userLevel}!`);
                // You can add visual or sound effects for level up here
                xpNeeded = getXPForNextLevel(userLevel); 
            }
            
            if (userLevel === MAX_LEVEL && currentXP > 0) {
                currentXP = 0; 
            }
            
            saveUserData(); // Save data after each XP addition
            updateLevelDisplay(); // Update XP and level display
        }

        // Function to load user data from localStorage
        function loadUserData() {
            const savedLevel = localStorage.getItem('futSwipeUserLevel');
            const savedXP = localStorage.getItem('futSwipeCurrentXP');
            const savedCollection = localStorage.getItem('futSwipePermanentCollection');
            const savedSessionLength = localStorage.getItem('futSwipeMaxSwipesPerSession');
            const savedCardPresets = localStorage.getItem('futSwipeCurrentCardPreset'); // Read as JSON array
            const savedOVRMin = localStorage.getItem('futSwipeOVRMin');
            const savedOVRMax = localStorage.getItem('futSwipeOVRMax');
            const savedLanguage = localStorage.getItem('futSwipeLanguage');

            if (savedLevel !== null) userLevel = parseInt(savedLevel);
            if (savedXP !== null) currentXP = parseInt(savedXP);
            if (savedCollection !== null) permanentCollection = JSON.parse(savedCollection);
            if (savedSessionLength !== null) MAX_SWIPES_PER_SESSION = parseInt(savedSessionLength);
            
            if (savedCardPresets !== null) {
                try {
                    const parsed = JSON.parse(savedCardPresets);
                    if (Array.isArray(parsed)) {
                        selectedCardPresets = parsed;
                    } else if (typeof parsed === 'string') { // Old single-string format
                        selectedCardPresets = [parsed];
                    }
                } catch (e) {
                    // Fallback if parsing fails or old format is just a raw string
                    selectedCardPresets = [savedCardPresets];
                }
            }
            
            if (savedOVRMin !== null) ovrFilterMin = parseInt(savedOVRMin);
            if (savedOVRMax !== null) ovrFilterMax = parseInt(savedOVRMax);

            // Set language from saved preference, default to English
            currentLanguage = savedLanguage || 'en';
            updateLanguage(); // Update language display and content

            updateLevelDisplay(); // Update display on load
        }

        // Function to save user data to localStorage
        function saveUserData() {
            localStorage.setItem('futSwipeUserLevel', userLevel);
            localStorage.setItem('futSwipeCurrentXP', currentXP);
            localStorage.setItem('futSwipePermanentCollection', JSON.stringify(permanentCollection));
            localStorage.setItem('futSwipeMaxSwipesPerSession', MAX_SWIPES_PER_SESSION);
            localStorage.setItem('futSwipeCurrentCardPreset', JSON.stringify(selectedCardPresets)); // Save as JSON string
            localStorage.setItem('futSwipeOVRMin', ovrFilterMin);
            localStorage.setItem('futSwipeOVRMax', ovrFilterMax);
            localStorage.setItem('futSwipeLanguage', currentLanguage);
        }
        
        // Function to update level and XP bar display
        function updateLevelDisplay() {
            currentLevelSpan.textContent = userLevel;
            
            if (userLevel >= MAX_LEVEL) {
                xpProgressSpan.textContent = `${translations[currentLanguage].maxLevel} (${MAX_LEVEL})`;
                xpBar.style.width = '100%';
                xpBar.style.backgroundColor = 'gold'; 
            } else {
                const xpNeeded = getXPForNextLevel(userLevel);
                const percentage = (currentXP / xpNeeded) * 100;
                xpBar.style.width = `${percentage}%`;
                xpBar.style.backgroundColor = '#00ff00'; 
                xpProgressSpan.textContent = `${currentXP} / ${xpNeeded} XP`;
            }
        }
        // --- End of Level System Functions ---


        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function formatPlayerNameAndOVR(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1]; 

            const ovrMatch = filename.match(/_(\d+)_OVR/);
            const ovr = ovrMatch ? parseInt(ovrMatch[1]) : 0;

            const cleanFilename = filename.replace(/_\d+_OVR_.*\.webp$/, '').replace(/\.webp$/, '');
            
            const namePartsArray = cleanFilename.split('_');
            let formattedName = '';

            if (namePartsArray.length >= 2) {
                formattedName = `${namePartsArray[0]} ${namePartsArray[1]}`;
            } else {
                formattedName = namePartsArray[0] || 'Unknown Name';
            }
            
            formattedName = decodeURIComponent(formattedName).replace(/_/g, ' ').trim();

            const cardTypeMatch = filename.match(/_OVR_(.*?)\.webp/);
            const rawCardType = cardTypeMatch ? cardTypeMatch[1] : 'unknown';

            return { name: formattedName, ovr: ovr, rawCardType: rawCardType };
        }

        // Create card for base interface
        function createCard(player) {
            const card = document.createElement('div');
            card.classList.add('card');
            card.setAttribute('data-id', player.id);

            const playerInfo = formatPlayerNameAndOVR(player.URL);

            card.innerHTML = `
                <img src="${player.URL}" alt="${playerInfo.name}" class="card-image">
                <div class="card-info">
                    <p class="player-name">${playerInfo.name}</p>
                    <p class="player-ovr">${playerInfo.ovr}</p>
                    <p class="card-type">${translations[currentLanguage].cardType}: ${formatCardType(player.cardType)}</p>
                </div>
            `;
            return card;
        }

        function formatCardType(cardType) {
            return cardType.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
        }

        function displayNextCard() {
            if (swipeCounter >= currentSessionPlayers.length) {
                endRound();
                return;
            }

            if (currentPlayerIndex < currentSessionPlayers.length) {
                const player = currentSessionPlayers[currentPlayerIndex];
                const card = createCard(player);
                cardStack.appendChild(card);
                attachSwipeEvents(card);
                updateSwipeCount();

                // Preload next image
                if (currentPlayerIndex + 1 < currentSessionPlayers.length) {
                    const nextPlayer = currentSessionPlayers[currentPlayerIndex + 1];
                    const img = new Image();
                    img.src = nextPlayer.URL;
                }
            } else {
                endRound();
            }
        }

        function updateSwipeCount() {
            swipeCounterTop.textContent = `${swipeCounter} / ${currentSessionPlayers.length}`;
        }

        function showSwipeMessage(type) {
            const message = type === 'like' ? likeMessage : nopeMessage;
            message.classList.add('visible');
            setTimeout(() => {
                message.classList.remove('visible');
            }, 800);
        }

        function performSwipe(direction) {
            const currentCard = cardStack.querySelector('.card');
            if (currentCard && !isSwiping) {
                dislikeBtn.disabled = true;
                likeBtn.disabled = true;

                swipeCard(currentCard, direction);

                // Add XP for each swipe
                if (direction === 'right') { // It's a "Like"
                    addXP(5); // Gain 5 XP for a Like
                } else { // It's a "Nope"
                    addXP(1); // Gain 1 XP for a Nope
                }

                setTimeout(() => {
                    dislikeBtn.disabled = false;
                    likeBtn.disabled = false;
                }, 400);
            }
        }

        function swipeCard(card, direction) {
            card.style.transition = 'transform 0.4s ease-out, opacity 0.4s ease-out';
            if (direction === 'left') {
                card.style.transform = 'translateX(-150%) rotate(-30deg)';
                showSwipeMessage('nope');
            } else {
                card.style.transform = 'translateX(150%) rotate(30deg)';
                showSwipeMessage('like');
                const playerToLike = currentSessionPlayers[currentPlayerIndex];
                likedPlayersInSession.push(playerToLike);
                // Add to permanent collection if not already present
                if (!permanentCollection.some(p => p.id === playerToLike.id)) {
                    permanentCollection.push(playerToLike);
                    saveUserData(); // Save collection after each addition
                }
            }
            card.style.opacity = '0';

            setTimeout(() => {
                card.remove();
                currentPlayerIndex++;
                swipeCounter++;
                displayNextCard();
            }, 400);
        }

        function endRound() {
            console.log("Round ended! Players liked in session:", likedPlayersInSession);
            addXP(20); // Gain 20 XP for finishing the series
            displayTeamModal();
        }

        function calculateTeamOverallRating() {
            if (likedPlayersInSession.length === 0) {
                return 0;
            }
            const totalOVR = likedPlayersInSession.reduce((sum, player) => sum + player.ovr, 0);
            return Math.round(totalOVR / likedPlayersInSession.length);
        }

        function displayPlayersInGrid(players, gridElement, countElement) {
            gridElement.innerHTML = '';
            
            if (players.length === 0) {
                gridElement.innerHTML = `<p style="grid-column: 1 / -1; margin-top: 50px;">${translations[currentLanguage].noPlayersFound}</p>`;
                if (countElement) {
                    countElement.textContent = `${translations[currentLanguage].totalCards}: 0`;
                }
            } else {
                // Sort players for collection: by card type, then by OVR (descending)
                const sortedPlayers = [...players].sort((a, b) => {
                    // Sort by card type (alphabetical order)
                    const typeComparison = a.cardType.localeCompare(b.cardType);
                    if (typeComparison !== 0) {
                        return typeComparison;
                    }
                    // If card type is the same, sort by OVR (descending)
                    return b.ovr - a.ovr;
                });

                sortedPlayers.forEach(player => {
                    const playerInfo = formatPlayerNameAndOVR(player.URL);
                    const playerCard = document.createElement('div');
                    playerCard.classList.add('team-player-card'); // Reuse class for styling
                    playerCard.innerHTML = `
                        <img src="${player.URL}" alt="${playerInfo.name}">
                        <div class="player-details">
                            <p class="player-name-modal">${playerInfo.name}</p>
                            <p class="player-ovr">${playerInfo.ovr}</p>
                            <p class="card-type-modal">${formatCardType(player.cardType)}</p>
                        </div>
                    `;
                    gridElement.appendChild(playerCard);
                });
                if (countElement) {
                    countElement.textContent = `${translations[currentLanguage].totalCards}: ${players.length}`;
                }
            }
        }

        function displayTeamModal() {
            const overallRating = calculateTeamOverallRating();
            teamOverallRating.textContent = `${translations[currentLanguage].teamOverallRating}: ${overallRating}`;
            displayPlayersInGrid(likedPlayersInSession, teamGrid); // Use likedPlayersInSession here
            teamModal.style.display = 'flex';
        }

        function displayCollectionModal() {
            // For collection, we want it sorted and displayed without category titles
            displayPlayersInGrid(permanentCollection, collectionGrid, collectionCountDisplay);
            collectionModal.style.display = 'flex';
        }

        // Refactored startGame to handle resetting liked players for the session
        function startGame(resetLikedPlayers = true) {
            if (resetLikedPlayers) {
                likedPlayersInSession = []; // Reset liked players for the session only if requested
            }
            currentPlayerIndex = 0;
            swipeCounter = 0;
            cardStack.innerHTML = '';
            sideMenu.classList.remove('open');
            seriesSelectionModal.style.display = 'none';
            presetSelectionModal.style.display = 'none';
            ovrSelectionModal.style.display = 'none';
            teamModal.style.display = 'none';
            collectionModal.style.display = 'none';


            let playersToUse = allPlayersData;
            
            // Apply preset filter (now multiple)
            if (!selectedCardPresets.includes('all')) { 
                playersToUse = playersToUse.filter(player => selectedCardPresets.includes(player.cardType));
            }

            playersToUse = playersToUse.filter(player => {
                return player.ovr >= ovrFilterMin && player.ovr <= ovrFilterMax;
            });
            
            shuffleArray(playersToUse);
            currentSessionPlayers = playersToUse.slice(0, Math.min(MAX_SWIPES_PER_SESSION, playersToUse.length));
            
            updateSwipeCount();
            displayNextCard();
        }

        function resetAndStartGame() { // Used for "New Game" and filters (resets liked players)
            startGame(true); 
        }

        function refreshCurrentSeries() { // New function for refresh button (keeps liked players)
            startGame(false); 
            alert(translations[currentLanguage].newSeriesGenerated);
        }


        // --- Swipe event handling (drag and drop) ---
        let startX;
        let currentX;
        let isSwiping = false;

        function attachSwipeEvents(card) {
            card.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                isSwiping = true;
                startX = e.clientX;
                card.style.transition = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isSwiping) return;
                currentX = e.clientX;
                const deltaX = currentX - startX;
                card.style.transform = `translateX(${deltaX}px) rotate(${deltaX / 20}deg)`;

                if (deltaX > 50) {
                    likeMessage.classList.add('visible');
                    nopeMessage.classList.remove('visible');
                } else if (deltaX < -50) {
                    nopeMessage.classList.add('visible');
                    likeMessage.classList.remove('visible');
                } else {
                    likeMessage.classList.remove('visible');
                    nopeMessage.classList.remove('visible');
                }
            });

            document.addEventListener('mouseup', () => {
                if (!isSwiping) return;
                isSwiping = false;
                const deltaX = currentX - startX;

                likeMessage.classList.remove('visible');
                nopeMessage.classList.remove('visible');

                if (deltaX > 100) {
                    performSwipe('right');
                } else if (deltaX < -100) {
                    performSwipe('left');
                } else {
                    card.style.transition = 'transform 0.3s ease-out';
                    card.style.transform = 'translateX(0) rotate(0)';
                }
            });

            // Mobile - Touch
            card.addEventListener('touchstart', (e) => {
                isSwiping = true;
                startX = e.touches[0].clientX;
                card.style.transition = 'none';
            });

            card.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                currentX = e.touches[0].clientX;
                const deltaX = currentX - startX;
                card.style.transform = `translateX(${deltaX}px) rotate(${deltaX / 20}deg)`;

                if (deltaX > 50) {
                    likeMessage.classList.add('visible');
                    nopeMessage.classList.remove('visible');
                } else if (deltaX < -50) {
                    nopeMessage.classList.add('visible');
                    likeMessage.classList.remove('visible');
                } else {
                    likeMessage.classList.remove('visible');
                    nopeMessage.classList.remove('visible');
                }
            });

            card.addEventListener('touchend', () => {
                if (!isSwiping) return;
                isSwiping = false;
                const deltaX = currentX - startX;

                likeMessage.classList.remove('visible');
                nopeMessage.classList.remove('visible');

                if (deltaX > 100) {
                    performSwipe('right');
                } else if (deltaX < -100) {
                    performSwipe('left');
                } else {
                    card.style.transition = 'transform 0.3s ease-out';
                    card.style.transform = 'translateX(0) rotate(0)';
                }
            });
        }


        // --- Data loading and initialization ---
        async function loadAllPlayers() {
            try {
                // Use direct URL of JSON file on GitHub
                const response = await fetch('https://raw.githubusercontent.com/Tristanox/FUT-25-assets/refs/heads/main/fut_25_images.json');
                const data = await response.json();

                cardTypesCount = { 'all': 0 };

                let tempMaxOVR = 0;
                let idCounter = 0;
                for (const cardType in data) {
                    cardTypesCount[cardType] = data[cardType].length;
                    data[cardType].forEach(player => {
                        const ovr = formatPlayerNameAndOVR(player.URL).ovr;
                        allPlayersData.push({
                            id: idCounter++, // Use a unique ID for each player
                            URL: player.URL,
                            cardType: cardType,
                            ovr: ovr
                        });
                        if (ovr > tempMaxOVR) {
                            tempMaxOVR = ovr;
                        }
                    });
                    cardTypesCount['all'] += data[cardType].length;
                }
                maxOVRFound = tempMaxOVR;
                ovrMaxRange.max = maxOVRFound;
                ovrMaxRange.value = maxOVRFound;
                updateOVRRangeDisplay();

                availableCardTypes = Object.keys(data);
                availableCardTypes.sort();
                availableCardTypes.unshift('all');

                loadUserData(); // <-- Load user data here
                startGame();
            } catch (error) {
                console.error("Error loading players:", error);
                document.body.innerHTML = `<p style='color: white; text-align: center; font-size: 1.5em; margin-top: 50px;'>${translations[currentLanguage].loadingError}</p>`;
            }
        }

        // --- Event listeners for Like/Dislike buttons ---
        dislikeBtn.addEventListener('click', () => performSwipe('left'));
        likeBtn.addEventListener('click', () => performSwipe('right'));

        // --- Event listeners for series settings modal ---
        seriesRange.addEventListener('input', () => {
            let value = parseInt(seriesRange.value);
            // Adjustment for specific steps (10, 50, 100)
            if (value <= 30) {
                value = 10;
            } else if (value > 30 && value <= 70) {
                value = 50;
            } else {
                value = 100;
            }
            seriesRange.value = value;
            sliderValueDisplay.textContent = value;
        });

        applySeriesLengthBtn.addEventListener('click', () => {
            MAX_SWIPES_PER_SESSION = parseInt(seriesRange.value);
            saveUserData(); 
            resetAndStartGame();
        });

        closeSeriesModalBtn.addEventListener('click', () => {
            seriesSelectionModal.style.display = 'none';
        });

        // Close final team modal
        closeTeamModalBtn.addEventListener('click', () => {
            teamModal.style.display = 'none';
        });

        // Close collection modal
        closeCollectionModalBtn.addEventListener('click', () => {
            collectionModal.style.display = 'none';
        });

        // Close modals by clicking outside (generic)
        window.addEventListener('click', (event) => {
            if (event.target == teamModal) {
                teamModal.style.display = 'none';
            }
            if (event.target == collectionModal) {
                collectionModal.style.display = 'none';
            }
            if (event.target == seriesSelectionModal) {
                seriesSelectionModal.style.display = 'none';
            }
            if (event.target == presetSelectionModal) {
                presetSelectionModal.style.display = 'none';
            }
            if (event.target == ovrSelectionModal) {
                ovrSelectionModal.style.display = 'none';
            }
        });

        // --- Burger Menu Management ---
        burgerMenuBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            sideMenu.classList.add('open');
        });

        closeSideMenuBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
        });

        resetGameMenuBtn.addEventListener('click', () => {
            selectedCardPresets = ['all']; // Reset preset to 'all'
            ovrFilterMin = 64;
            ovrFilterMax = maxOVRFound;
            permanentCollection = []; 
            saveUserData(); 
            updateLevelDisplay(); 
            resetAndStartGame();
        });

        viewTeamMenuBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            displayTeamModal();
        });

        viewCollectionMenuBtn.addEventListener('click', () => { 
            sideMenu.classList.remove('open');
            displayCollectionModal();
        });

        changeSeriesLengthBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            seriesRange.value = MAX_SWIPES_PER_SESSION;
            sliderValueDisplay.textContent = MAX_SWIPES_PER_SESSION;
            seriesSelectionModal.style.display = 'flex';
        });

        choosePresetBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            populatePresetList(); // Populate options BEFORE displaying modal
            presetSelectionModal.style.display = 'flex'; // Display modal
        });

        closePresetModalBtn.addEventListener('click', () => {
            presetSelectionModal.style.display = 'none';
        });

        filterByOVRBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            ovrMinRange.value = ovrFilterMin;
            ovrMaxRange.value = ovrFilterMax;
            ovrMinRange.max = maxOVRFound;
            ovrMaxRange.max = maxOVRFound;
            updateOVRRangeDisplay();
            ovrSelectionModal.style.display = 'flex';
        });

        closeOvrModalBtn.addEventListener('click', () => {
            ovrSelectionModal.style.display = 'none';
        });

        ovrMinRange.addEventListener('input', () => {
            if (parseInt(ovrMinRange.value) > parseInt(ovrMaxRange.value)) {
                ovrMinRange.value = ovrMaxRange.value;
            }
            updateOVRRangeDisplay();
        });

        ovrMaxRange.addEventListener('input', () => {
            if (parseInt(ovrMaxRange.value) < parseInt(ovrMinRange.value)) {
                ovrMaxRange.value = ovrMinRange.value;
            }
            updateOVRRangeDisplay();
        });

        function updateOVRRangeDisplay() {
            ovrRangeValue.textContent = `${ovrMinRange.value} - ${ovrMaxRange.value}`;
        }

        applyOvrFilterBtn.addEventListener('click', () => {
            ovrFilterMin = parseInt(ovrMinRange.value);
            ovrFilterMax = parseInt(ovrMaxRange.value);
            saveUserData(); 
            resetAndStartGame();
        });


        // Function to populate preset list (now with checkboxes)
        function populatePresetList() {
            presetOptionsDiv.innerHTML = ''; // Clear container
            availableCardTypes.forEach(type => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('preset-option-item');

                const checkboxId = `preset-${type}`;
                const isChecked = selectedCardPresets.includes(type);
                
                // Explicitly create elements
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = checkboxId;
                checkbox.value = type;
                checkbox.checked = isChecked;

                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                label.innerHTML = `
                    <span>${type === 'all' ? translations[currentLanguage].allCards : formatCardType(type)}</span>
                    <span class="card-count">${cardTypesCount[type] || 0}</span>
                `;
                
                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                
                if (isChecked) {
                    itemDiv.classList.add('selected');
                }

                presetOptionsDiv.appendChild(itemDiv);

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        itemDiv.classList.add('selected');
                    } else {
                        itemDiv.classList.remove('selected');
                    }
                    // Logic to handle "All cards" selection
                    if (type === 'all' && checkbox.checked) {
                        presetOptionsDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb.value !== 'all') {
                                cb.checked = false;
                                cb.closest('.preset-option-item').classList.remove('selected');
                            }
                        });
                    } else if (type !== 'all' && checkbox.checked) {
                        const allCheckbox = presetOptionsDiv.querySelector('#preset-all');
                        if (allCheckbox && allCheckbox.checked) {
                            allCheckbox.checked = false;
                            allCheckbox.closest('.preset-option-item').classList.remove('selected');
                        }
                    }
                });
                // Allow clicking on the div element to toggle the checkbox
                itemDiv.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') { // Avoid double-click if clicking directly on the checkbox
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change')); // Trigger change event to update style and logic
                    }
                });
            });
            // The "applyPresetFilterBtn" listener is moved outside to be attached only once.
        }


        // --- Export/Import stats functions ---
        function exportUserData() {
            const dataToExport = {
                userLevel: userLevel,
                currentXP: currentXP,
                permanentCollection: permanentCollection,
                MAX_SWIPES_PER_SESSION: MAX_SWIPES_PER_SESSION,
                selectedCardPresets: selectedCardPresets, // Use new variable name
                ovrFilterMin: ovrFilterMin,
                ovrFilterMax: ovrFilterMax,
                language: currentLanguage // Export current language
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fut_swipe_stats.json';
            document.body.appendChild(a); 
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert(translations[currentLanguage].statsExported);
        }

        // Create a hidden file input for import
        const importFileInput = document.createElement('input');
        importFileInput.type = 'file';
        importFileInput.accept = '.json';
        importFileInput.style.display = 'none';
        document.body.appendChild(importFileInput); 

        function importUserData() {
            importFileInput.click(); 
        }

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (typeof importedData.userLevel === 'number') userLevel = importedData.userLevel;
                    if (typeof importedData.currentXP === 'number') currentXP = importedData.currentXP;
                    if (Array.isArray(importedData.permanentCollection)) permanentCollection = importedData.permanentCollection;
                    if (typeof importedData.MAX_SWIPES_PER_SESSION === 'number') MAX_SWIPES_PER_SESSION = importedData.MAX_SWIPES_PER_SESSION;
                    
                    // Handle import of old or new preset structure
                    if (Array.isArray(importedData.selectedCardPresets)) {
                        selectedCardPresets = importedData.selectedCardPresets;
                    } else if (typeof importedData.currentCardPreset === 'string') { // Backward compatibility
                        selectedCardPresets = [importedData.currentCardPreset];
                    } else {
                        selectedCardPresets = ['all']; // Default if unknown
                    }

                    if (typeof importedData.ovrFilterMin === 'number') ovrFilterMin = importedData.ovrFilterMin;
                    if (typeof importedData.ovrFilterMax === 'number') ovrFilterMax = importedData.ovrFilterMax;
                    if (typeof importedData.language === 'string') {
                        currentLanguage = importedData.language; // Import language
                    }

                    saveUserData(); 
                    updateLevelDisplay(); 
                    updateLanguage(); // Update language after import
                    startGame(); 
                    alert(translations[currentLanguage].statsImportedSuccess);

                } catch (error) {
                    console.error('Error importing stats:', error);
                    alert(translations[currentLanguage].importError);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        });

        // --- Event listeners for new action buttons ---
        exportStatsBtn.addEventListener('click', exportUserData);
        importStatsBtn.addEventListener('click', importUserData);
        refreshSeriesBtn.addEventListener('click', refreshCurrentSeries); // New refresh button

        // The listener for applyPresetFilterBtn is moved here to be attached only once.
        applyPresetFilterBtn.addEventListener('click', () => {
            const selectedCheckboxes = presetOptionsDiv.querySelectorAll('input[type="checkbox"]:checked');
            selectedCardPresets = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (selectedCardPresets.length === 0) {
                selectedCardPresets = ['all']; // Default to 'all' if nothing is selected
                alert(translations[currentLanguage].noCardTypeSelected);
            } else if (selectedCardPresets.includes('all') && selectedCardPresets.length > 1) {
                selectedCardPresets = ['all']; // If 'all' is checked with others, only 'all' is kept
                alert(translations[currentLanguage].allCardsSelectedIgnored);
            }
            
            saveUserData();
            resetAndStartGame();
        });


        // Close menu if clicked outside
        window.addEventListener('click', (event) => {
            if (!sideMenu.contains(event.target) && event.target !== burgerMenuBtn && !burgerMenuBtn.contains(event.target) && event.target !== exportStatsBtn && !exportStatsBtn.contains(event.target) && event.target !== importStatsBtn && !importStatsBtn.contains(event.target) && event.target !== refreshSeriesBtn && !refreshSeriesBtn.contains(event.target) && event.target !== languageToggleBtn && !languageToggleBtn.contains(event.target)) {
                sideMenu.classList.remove('open');
            }
        });

        // --- Event listener for keyboard keys ---
        document.addEventListener('keydown', (e) => {
            if (teamModal.style.display === 'flex' || collectionModal.style.display === 'flex' || seriesSelectionModal.style.display === 'flex' || presetSelectionModal.style.display === 'flex' || ovrSelectionModal.style.display === 'flex' || sideMenu.classList.contains('open')) {
                return;
            }

            if (e.key === 'ArrowLeft') {
                performSwipe('left');
            } else if (e.key === 'ArrowRight') {
                performSwipe('right');
            }
        });

        // --- Language Management ---
        const translations = {
            en: {
                mainTitle: "FUT Swipe - The Player Tinder",
                levelText: "Level",
                maxLevel: "Max Level",
                cardType: "Card Type",
                noPlayersFound: "No players found yet!",
                totalCards: "Total cards",
                teamOverallRating: "Team Overall Rating",
                dreamTeamTitle: "Your Dream Team! ⚽",
                teamModalFooter: "Click on a player to see more details (feature coming soon).",
                myCollectionTitle: "My Collection 🏆",
                newGame: "New Game",
                viewTeam: "View Team",
                myCollection: "My Collection",
                changeSeriesLength: "Change Series Length",
                choosePreset: "Choose Preset",
                filterByOVR: "Filter by OVR",
                adjustSeriesLengthTitle: "Adjust Series Length",
                numberOfSwipesLabel: "Number of swipes :",
                applyAndRestart: "Apply & Restart",
                chooseCardTypeTitle: "Choose one or more card types",
                allCards: "All cards",
                applySelection: "Apply Selection",
                filterByOVRTitle: "Filter by OVR",
                minRatingLabel: "Minimum Rating :",
                maxRatingLabel: "Maximum Rating :",
                statsExported: "Your stats have been exported to fut_swipe_stats.json!",
                newSeriesGenerated: "New card series generated!",
                noCardTypeSelected: "No card type selected. 'All cards' will be used by default.",
                allCardsSelectedIgnored: "'All cards' was selected, other selections were ignored.",
                statsImportedSuccess: "Your stats have been successfully imported!",
                importError: "Error during import. The file is not a valid JSON or is corrupted.",
                loadingError: "Error: Unable to load players. Please check connection or assets URL."
            },
            fr: {
                mainTitle: "FUT Swipe - Le Tinder des Joueurs",
                levelText: "Niveau",
                maxLevel: "Niveau Max",
                cardType: "Type de carte",
                noPlayersFound: "Aucun joueur trouvé pour l'instant !",
                totalCards: "Total de cartes",
                teamOverallRating: "Note Générale de l'Équipe",
                dreamTeamTitle: "Votre Équipe de Rêve ! ⚽",
                teamModalFooter: "Cliquez sur un joueur pour voir plus de détails (fonctionnalité à venir).",
                myCollectionTitle: "Ma Collection 🏆",
                newGame: "Nouvelle Partie",
                viewTeam: "Voir l'Équipe",
                myCollection: "Ma Collection",
                changeSeriesLength: "Changer Longueur Série",
                choosePreset: "Choisir un Preset",
                filterByOVR: "Filtrer par Note (OVR)",
                adjustSeriesLengthTitle: "Ajuster la longueur de la série",
                numberOfSwipesLabel: "Nombre de swipes :",
                applyAndRestart: "Appliquer & Recommencer",
                chooseCardTypeTitle: "Choisir un ou plusieurs types de carte",
                allCards: "Toutes les cartes",
                applySelection: "Appliquer la sélection",
                filterByOVRTitle: "Filtrer par Note (OVR)",
                minRatingLabel: "Note Minimale :",
                maxRatingLabel: "Note Maximale :",
                statsExported: "Vos stats ont été exportées en fut_swipe_stats.json !",
                newSeriesGenerated: "Nouvelle série de cartes générée !",
                noCardTypeSelected: "Aucun type de carte sélectionné. 'Toutes les cartes' sera utilisé par défaut.",
                allCardsSelectedIgnored: "'Toutes les cartes' a été sélectionné, les autres sélections ont été ignorées.",
                statsImportedSuccess: "Vos stats ont été importées avec succès !",
                importError: "Erreur lors de l'importation. Le fichier n'est pas un JSON valide ou est corrompu.",
                loadingError: "Erreur : Impossible de charger les joueurs. Veuillez vérifier la connexion ou l'URL des assets."
            }
        };

        let currentLanguage = 'en'; // Default language is English

        function updateLanguage() {
            // Update main title
            document.getElementById('mainTitle').textContent = translations[currentLanguage].mainTitle;
            // Update level display
            document.getElementById('levelText').textContent = translations[currentLanguage].levelText;
            // Update side menu buttons
            document.getElementById('resetGameMenuBtn').textContent = translations[currentLanguage].newGame;
            document.getElementById('viewTeamMenuBtn').textContent = translations[currentLanguage].viewTeam;
            document.getElementById('viewCollectionMenuBtn').textContent = translations[currentLanguage].myCollection;
            document.getElementById('changeSeriesLengthBtn').textContent = translations[currentLanguage].changeSeriesLength;
            document.getElementById('choosePresetBtn').textContent = translations[currentLanguage].choosePreset;
            document.getElementById('filterByOVRBtn').textContent = translations[currentLanguage].filterByOVR;
            // Update series selection modal
            document.getElementById('adjustSeriesLengthTitle').textContent = translations[currentLanguage].adjustSeriesLengthTitle;
            document.getElementById('numberOfSwipesLabel').textContent = translations[currentLanguage].numberOfSwipesLabel;
            document.getElementById('applySeriesLengthBtn').textContent = translations[currentLanguage].applyAndRestart;
            // Update preset selection modal
            document.getElementById('chooseCardTypeTitle').textContent = translations[currentLanguage].chooseCardTypeTitle;
            document.getElementById('applyPresetFilterBtn').textContent = translations[currentLanguage].applySelection;
            // Update OVR selection modal
            document.getElementById('filterByOVRTitle').textContent = translations[currentLanguage].filterByOVRTitle;
            document.getElementById('minRatingLabel').textContent = translations[currentLanguage].minRatingLabel;
            document.getElementById('maxRatingLabel').textContent = translations[currentLanguage].maxRatingLabel;
            document.getElementById('applyOvrFilterBtn').textContent = translations[currentLanguage].applyAndRestart;
            // Update team modal
            document.getElementById('dreamTeamTitle').textContent = translations[currentLanguage].dreamTeamTitle;
            document.getElementById('teamModalFooter').textContent = translations[currentLanguage].teamModalFooter;
            // Update collection modal
            document.getElementById('myCollectionTitle').textContent = translations[currentLanguage].myCollectionTitle;

            // Update language flag image
            if (currentLanguage === 'en') {
                languageFlag.src = "https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/France-flag.png";
                languageFlag.alt = "French Flag";
                document.documentElement.lang = 'en';
            } else {
                languageFlag.src = "https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/UK.png";
                languageFlag.alt = "UK Flag";
                document.documentElement.lang = 'fr';
            }

            // Re-populate preset list to update "All cards" text
            if (presetSelectionModal.style.display === 'flex') {
                populatePresetList();
            }
            // Update other dynamic texts that are not directly tied to a button/title
            updateLevelDisplay(); // To update Max Level text
            updateSwipeCount(); // To update swipe counter text
            // Re-display modals if open to update their content
            if (teamModal.style.display === 'flex') displayTeamModal();
            if (collectionModal.style.display === 'flex') displayCollectionModal();
        }

        languageToggleBtn.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'en' ? 'fr' : 'en';
            saveUserData(); // Save language preference
            updateLanguage();
        });

        // Initialisation on page load
        loadAllPlayers();
    </script>
</body>
</html>

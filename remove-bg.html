<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supprimeur de Fond d'Images 100% En Ligne</title>
    <style>
        /* --- CSS intégré avec la nouvelle palette --- */
        :root {
            --color-darkest: #1E2124;
            --color-darker: #282B30;
            --color-dark: #36393E;
            --color-medium: #424549;
            --color-accent-light: #55FF75; /* Vert vif */
            --color-accent-dark: #72DA72; /* Vert plus doux */
            --color-text-light: #f4f7f6; /* Texte clair pour fond sombre */
            --color-text-medium: #bbb;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--color-darkest);
            color: var(--color-text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--color-darker);
            padding: 40px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 100%;
            max-width: 700px;
            border: 1px solid var(--color-medium);
        }

        h1 {
            color: var(--color-accent-light);
            margin-bottom: 15px;
            font-size: 2.2em;
            text-shadow: 0 0 5px rgba(85, 255, 117, 0.5);
        }

        p {
            font-size: 1.1em;
            color: var(--color-text-medium);
            margin-bottom: 25px;
        }

        input[type="file"] {
            display: none;
        }

        .upload-button {
            background-color: var(--color-accent-dark);
            color: var(--color-darkest);
            padding: 14px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-block;
            width: fit-content;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            font-weight: bold;
        }

        .upload-button:hover {
            background-color: var(--color-accent-light);
            transform: translateY(-2px);
        }

        .file-info {
            font-size: 0.95em;
            color: var(--color-text-medium);
            margin-bottom: 20px;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            display: none;
            background-color: var(--color-medium);
            color: var(--color-text-light);
        }

        .status-message.loading {
            background-color: var(--color-medium);
            color: var(--color-accent-light);
            display: block;
        }

        .status-message.processing {
            background-color: var(--color-medium);
            color: var(--color-accent-light);
            display: block;
        }

        .status-message.success {
            background-color: var(--color-accent-dark);
            color: var(--color-darkest);
            display: block;
        }

        .status-message.error {
            background-color: #dc3545;
            color: white;
            display: block;
        }

        .loading-spinner {
            border: 4px solid var(--color-dark);
            border-top: 4px solid var(--color-accent-light);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Styles pour les aperçus des images importées --- */
        #inputPreviewContainer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--color-medium);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .input-image-box {
            width: 120px;
            height: 120px;
            border: 1px solid var(--color-medium);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--color-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .input-image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* --- Styles pour la barre de progression --- */
        .progress-bar-container {
            width: 90%;
            background-color: var(--color-dark);
            border-radius: 5px;
            margin: 20px auto;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Pour que la barre de remplissage ne dépasse pas les bords arrondis */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            display: none; /* Caché par défaut */
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--color-accent-light);
            border-radius: 5px;
            text-align: center;
            line-height: 25px; /* Centre le texte verticalement */
            color: var(--color-darkest);
            font-weight: bold;
            transition: width 0.3s ease-in-out;
            white-space: nowrap; /* Empêche le texte de se briser */
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            color: var(--color-text-light); /* Texte par-dessus la barre */
            font-weight: bold;
            z-index: 1; /* S'assure que le texte est au-dessus de la barre de remplissage */
        }


        /* --- Styles pour les aperçus des images traitées --- */
        #outputContainer {
            margin-top: 30px;
            border-top: 1px solid var(--color-medium);
            padding-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .image-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 180px;
            background-color: var(--color-dark);
            border: 1px solid var(--color-medium);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding-bottom: 10px;
        }

        .image-preview img {
            max-width: 100%;
            height: auto;
            display: block;
            border-bottom: 1px solid var(--color-medium);
        }

        .image-preview p {
            font-size: 0.9em;
            color: var(--color-text-medium);
            margin: 10px 0 5px;
            word-wrap: break-word;
            padding: 0 10px;
            text-align: center;
        }

        .download-link {
            background-color: var(--color-accent-light);
            color: var(--color-darkest);
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
            display: inline-block;
            transition: background-color 0.3s ease;
            font-weight: bold;
        }

        .download-link:hover {
            background-color: var(--color-accent-dark);
        }

        .no-bg-image-box {
            position: relative;
            width: 100%;
            height: 150px;
            background-color: #3e4247;
            background-image: linear-gradient(45deg, #4c5055 25%, transparent 25%, transparent 75%, #4c5055 75%, #4c5055),
                              linear-gradient(45deg, #4c5055 25%, transparent 25%, transparent 75%, #4c5055 75%, #4c5055);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .no-bg-image-box img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supprimeur de Fond d'Images 100% En Ligne</h1>
        <p>Sélectionnez plusieurs images. Le traitement est effectué directement dans votre navigateur.</p>

        <input type="file" id="imageUpload" accept="image/*" multiple>
        <label for="imageUpload" class="upload-button">Sélectionner des images</label>
        <p id="fileCount" class="file-info">Aucun fichier sélectionné</p>

        <div id="statusMessage" class="status-message"></div>
        <div id="loadingSpinner" class="loading-spinner"></div>

        <div id="progressBarContainer" class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
            <span id="progressText" class="progress-text">0%</span>
        </div>

        <h2>Images Importées</h2>
        <div id="inputPreviewContainer">
            </div>

        <h2>Images Traitées</h2>
        <div id="outputContainer">
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.2.0/dist/background-removal.js"></script>

    <script>
        /* --- JavaScript intégré --- */
        document.addEventListener('DOMContentLoaded', () => {
            const imageUpload = document.getElementById('imageUpload');
            const fileCount = document.getElementById('fileCount');
            const statusMessage = document.getElementById('statusMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const inputPreviewContainer = document.getElementById('inputPreviewContainer'); // Nouveau
            const outputContainer = document.getElementById('outputContainer');
            const progressBarContainer = document.getElementById('progressBarContainer'); // Nouveau
            const progressBar = document.getElementById('progressBar'); // Nouveau
            const progressText = document.getElementById('progressText'); // Nouveau

            let filesToProcess = [];
            let imagesProcessedCount = 0;

            imageUpload.addEventListener('change', (event) => {
                filesToProcess = Array.from(event.target.files);
                inputPreviewContainer.innerHTML = ''; // Nettoie les anciens aperçus
                outputContainer.innerHTML = ''; // Nettoie les anciens résultats
                imagesProcessedCount = 0; // Réinitialise le compteur
                updateProgressBar(0, filesToProcess.length); // Réinitialise la barre de progression

                if (filesToProcess.length > 0) {
                    fileCount.textContent = `${filesToProcess.length} fichier(s) sélectionné(s)`;
                    displayInputPreviews(filesToProcess); // Affiche les aperçus des images importées
                    processImages(); // Déclenche le traitement
                } else {
                    fileCount.textContent = 'Aucun fichier sélectionné';
                    progressBarContainer.style.display = 'none'; // Cache la barre si pas de fichiers
                }
            });

            function displayInputPreviews(files) {
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgBox = document.createElement('div');
                        imgBox.className = 'input-image-box';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        imgBox.title = file.name; // Info-bulle au survol
                        imgBox.appendChild(img);
                        inputPreviewContainer.appendChild(imgBox);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function updateProgressBar(processed, total) {
                if (total === 0) {
                    progressBarContainer.style.display = 'none';
                    return;
                }
                progressBarContainer.style.display = 'flex'; // Affiche la barre
                const percentage = Math.round((processed / total) * 100);
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}% (${processed}/${total} images)`;
                progressBar.setAttribute('aria-valuenow', percentage);
                progressBar.setAttribute('aria-valuemax', total);
                progressBar.setAttribute('aria-valuemin', 0);
            }

            async function processImages() {
                statusMessage.style.display = 'block';
                statusMessage.className = 'status-message loading';
                statusMessage.textContent = 'Chargement du modèle d\'IA... (cela peut prendre un instant la première fois)';
                loadingSpinner.style.display = 'block';
                updateProgressBar(0, filesToProcess.length); // Initialise la barre

                try {
                    if (!window.backgroundRemoval) {
                         throw new Error("La bibliothèque @imgly/background-removal n'a pas été chargée. Veuillez vérifier votre connexion Internet ou la manière dont le fichier est ouvert (doit être via un serveur HTTP).");
                    }
                    await window.backgroundRemoval.ready();

                    statusMessage.className = 'status-message processing';
                    statusMessage.textContent = `Démarrage du traitement de ${filesToProcess.length} image(s)...`;

                    for (const file of filesToProcess) {
                        try {
                            const originalImageBitmap = await createImageBitmap(file);
                            const processedBlob = await window.backgroundRemoval.removeBackground(originalImageBitmap);
                            const processedUrl = URL.createObjectURL(processedBlob);

                            // Afficher l'image traitée
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'image-preview';

                            const noBgBox = document.createElement('div');
                            noBgBox.className = 'no-bg-image-box';
                            const processedImg = document.createElement('img');
                            processedImg.src = processedUrl;
                            processedImg.alt = `Image traitée de ${file.name}`;
                            noBgBox.appendChild(processedImg);

                            const fileNameParagraph = document.createElement('p');
                            fileNameParagraph.textContent = `Fichier: ${file.name}`;

                            const downloadLink = document.createElement('a');
                            downloadLink.href = processedUrl;
                            downloadLink.download = `${file.name.split('.')[0]}_no_bg.png`;
                            downloadLink.textContent = 'Télécharger';
                            downloadLink.className = 'download-link';

                            previewDiv.appendChild(noBgBox);
                            previewDiv.appendChild(fileNameParagraph);
                            previewDiv.appendChild(downloadLink);
                            outputContainer.appendChild(previewDiv);

                            imagesProcessedCount++;
                            updateProgressBar(imagesProcessedCount, filesToProcess.length);

                        } catch (imageError) {
                            console.error(`Erreur de traitement pour ${file.name}:`, imageError);
                            // Ne pas incrémenter imagesProcessedCount pour les erreurs si vous voulez que la barre reflète les succès.
                            // Si vous voulez qu'elle reflète les tentatives, incrémentez-la ici.
                            // Pour cette version, nous incrémentons seulement si le traitement réussit.
                            statusMessage.textContent = `Erreur lors du traitement de ${file.name}. Certaines images peuvent avoir échoué.`;
                            statusMessage.className = 'status-message error';
                        }
                    }

                    if (imagesProcessedCount === filesToProcess.length) {
                        statusMessage.textContent = 'Toutes les images ont été traitées avec succès !';
                        statusMessage.className = 'status-message success';
                    } else if (imagesProcessedCount > 0) {
                        statusMessage.textContent = `Traitement terminé. ${imagesProcessedCount} sur ${filesToProcess.length} images traitées avec succès.`;
                        statusMessage.className = 'status-message success';
                    } else {
                         statusMessage.textContent = 'Aucune image n\'a pu être traitée. Veuillez vérifier les fichiers.';
                         statusMessage.className = 'status-message error';
                    }


                } catch (generalError) {
                    console.error("Erreur générale lors du chargement ou du traitement:", generalError);
                    statusMessage.textContent = `Une erreur grave s'est produite: ${generalError.message}. Veuillez réessayer.`;
                    statusMessage.className = 'status-message error';
                } finally {
                    loadingSpinner.style.display = 'none';
                    // La barre de progression reste visible avec le résultat final
                }
            }
        });
    </script>
</body>
</html>
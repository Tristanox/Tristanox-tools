<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Checklist</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e2124; /* Noir très foncé de la palette */
            color: #f0f2f5; /* Texte clair pour contraste avec le fond sombre */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: #282b30; /* Gris-noir de la palette */
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Ombre plus prononcée */
            padding: 30px;
            width: 100%;
            max-width: 900px;
            text-align: center;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .io-buttons {
            display: flex;
            justify-content: center;
            gap: 10px; /* Espace entre les boutons */
            margin-bottom: 20px;
        }

        .io-buttons button {
            background-color: #424549; /* Couleur de base des boutons */
            color: #f0f2f5;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .io-buttons button:hover {
            background-color: #36393e;
            transform: translateY(-1px);
        }

        h1 {
            color: #55ff75; /* Vert vif de la palette pour le titre */
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        p {
            color: #bdc3c7; /* Gris clair pour les paragraphes */
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            width: 100%;
            margin-top: 20px;
        }

        .grid-item {
            background-color: #36393e; /* Gris foncé bleuté de la palette */
            border: 1px solid #424549; /* Gris foncé de la palette pour la bordure */
            border-radius: 8px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px 10px 10px 35px; /* Ajusté pour le rectangle de statut */
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .grid-item:hover {
            background-color: #424549; /* Gris foncé au survol de la case */
            border-color: #55ff75; /* Bordure verte au survol */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .grid-item.active {
            border-color: #55ff75; /* Vert vif quand la case est active */
            box-shadow: 0 0 0 3px rgba(85, 255, 117, 0.5); /* Ombre verte vive */
        }

        .grid-item textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-size: 1em;
            color: #f0f2f5; /* Texte clair dans le textarea */
            padding: 5px;
            box-sizing: border-box;
            outline: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
        }

        .grid-item .placeholder {
            color: #888; /* Gris légèrement plus foncé pour le placeholder */
            font-style: italic;
            pointer-events: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: calc(90% - 25px);
            left: calc(50% + 12.5px);
            font-size: 0.9em;
        }

        .status-button {
            position: absolute;
            top: 0;
            left: 0;
            width: 25px; /* Largeur augmentée pour être plus facile à cliquer */
            height: 100%;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            cursor: pointer;
            background-color: #e74c3c; /* Rouge conservé pour "non complété" si pas de couleur rouge dans palette */
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }

        .status-button.completed {
            background-color: #55ff75; /* Vert vif de la palette pour "complété" */
        }

        .status-button:hover {
            opacity: 0.8;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 900px;
            padding: 0 30px;
            box-sizing: border-box;
        }

        /* Styles généraux pour tous les boutons du bas */
        .button-group button {
            background-color: #424549; /* Gris foncé de la palette pour les boutons génériques */
            color: #f0f2f5;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .button-group button:hover {
            background-color: #36393e;
            transform: translateY(-1px);
        }

        .button-group button:active {
            transform: translateY(0);
        }

        #add-item-button {
            background-color: #55ff75; /* Vert vif de la palette pour le bouton "+" */
            color: #1e2124; /* Texte noir sur bouton vert vif */
            font-size: 1.5em;
            padding: 8px 15px;
        }

        #add-item-button:hover {
            background-color: #72da72; /* Vert pâle au survol du bouton "+" */
        }
        
        #language-button {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 0;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10008;
            pointer-events: all;
            transition: none;
            animation: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #language-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <button id="language-button" onclick="translatePage()">
        <img id="flag-icon" src="https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/France-flag.png" alt="Traduire en Français">
    </button>
    <div class="container" id="checklist-container">
        <div class="io-buttons">
            <button id="import-json-button" data-fr="Importer JSON" data-en="Import JSON">Importer JSON</button>
            <button id="export-json-button" data-fr="Exporter JSON" data-en="Export JSON">Exporter JSON</button>
            <button id="export-png-button" data-fr="Exporter en PNG" data-en="Export to PNG">Exporter en PNG</button>
            <input type="file" id="json-file-input" accept=".json" style="display: none;">
        </div>

        <h1 data-fr="Checklist" data-en="Checklist">Checklist</h1>
        <p data-fr="Cliquez sur une case pour ajouter ou modifier un élément." data-en="Click a box to add or edit an item.">Cliquez sur une case pour ajouter ou modifier un élément.</p>
        <div id="grid-container" class="grid-container">
            </div>
        <div class="button-group">
            <button id="clear-grid" data-fr="Effacer la grille" data-en="Clear grid">Effacer la grille</button>
            <button id="add-item-button">+</button>
        </div>
    </div>

    <script>
        const gridContainer = document.getElementById('grid-container');
        const clearGridButton = document.getElementById('clear-grid');
        const addItemButton = document.getElementById('add-item-button');
        
        const importJsonButton = document.getElementById('import-json-button');
        const exportJsonButton = document.getElementById('export-json-button');
        const jsonFileInput = document.getElementById('json-file-input');
        const exportPngButton = document.getElementById('export-png-button');
        const checklistContainer = document.getElementById('checklist-container');

        let currentLanguage = 'en';

        const translations = {
            fr: {
                'page-title': 'Checklist',
                'Import JSON': 'Importer JSON',
                'Export JSON': 'Exporter JSON',
                'Export to PNG': 'Exporter en PNG',
                'Checklist': 'Checklist',
                'Click a box to add or edit an item.': 'Cliquez sur une case pour ajouter ou modifier un élément.',
                'Clear grid': 'Effacer la grille',
                'Click to write...': 'Cliquez pour écrire...',
                'Importing a JSON file will replace the current checklist. Do you want to continue?': 'Importer un fichier JSON remplacera la checklist actuelle. Voulez-vous continuer ?',
                'Checklist imported successfully!': 'Checklist importée avec succès !',
                "Error importing file. Make sure it's a valid JSON.": "Erreur lors de l'importation du fichier. Assurez-vous qu'il s'agit d'un JSON valide.",
                'Are you sure you want to clear the entire checklist? This action is irreversible.': 'Voulez-vous vraiment effacer toute la checklist ? Cette action est irréversible.',
                'Unable to export to PNG. An error occurred.': "Impossible d'exporter en PNG. Une erreur est survenue."
            },
            en: {
                'page-title': 'Checklist',
                'Importer JSON': 'Import JSON',
                'Exporter JSON': 'Export JSON',
                'Exporter en PNG': 'Export to PNG',
                'Checklist': 'Checklist',
                'Cliquez sur une case pour ajouter ou modifier un élément.': 'Click a box to add or edit an item.',
                'Effacer la grille': 'Clear grid',
                'Cliquez pour écrire...': 'Click to write...',
                'Importer un fichier JSON remplacera la checklist actuelle. Voulez-vous continuer ?': 'Importing a JSON file will replace the current checklist. Do you want to continue?',
                'Checklist importée avec succès !': 'Checklist imported successfully!',
                "Erreur lors de l'importation du fichier. Assurez-vous qu'il s'agit d'un JSON valide.": "Error importing file. Make sure it's a valid JSON.",
                'Voulez-vous vraiment effacer toute la checklist ? Cette action est irréversible.': 'Are you sure you want to clear the entire checklist? This action is irreversible.',
                "Impossible d'exporter en PNG. Une erreur est survenue.": 'Unable to export to PNG. An error occurred.'
            }
        };

        function translatePage() {
            currentLanguage = currentLanguage === 'en' ? 'fr' : 'en';
            const flagIcon = document.getElementById('flag-icon');
            
            if (currentLanguage === 'fr') {
                flagIcon.src = 'https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/UK.png';
                flagIcon.alt = 'Translate to English';
                document.documentElement.lang = 'fr';
            } else {
                flagIcon.src = 'https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/France-flag.png';
                flagIcon.alt = 'Traduire en Français';
                document.documentElement.lang = 'en';
            }

            document.querySelectorAll('[data-fr]').forEach(element => {
                const textKey = element.dataset[currentLanguage];
                if (textKey) {
                    element.innerText = textKey;
                }
            });
            
            document.querySelectorAll('.grid-item textarea').forEach(textarea => {
                const placeholder = translations[currentLanguage]['Click to write...'];
                textarea.setAttribute('placeholder', placeholder);
                updateTextareaPlaceholder(textarea);
            });
            
            const pageTitle = document.getElementById('page-title');
            pageTitle.innerText = translations[currentLanguage]['page-title'];
        }

        // Fonction pour sauvegarder le contenu de la grille
        function saveGridContent() {
            const items = {};
            document.querySelectorAll('.grid-item').forEach((itemDiv, index) => {
                const textarea = itemDiv.querySelector('textarea');
                const isCompleted = itemDiv.querySelector('.status-button').classList.contains('completed');
                items[`item-${index}`] = {
                    text: textarea.value,
                    completed: isCompleted
                };
            });
            localStorage.setItem('checklistGrid', JSON.stringify(items));
        }

        // Fonction pour charger le contenu de la grille
        function loadGridContent() {
            const savedItems = localStorage.getItem('checklistGrid');
            if (savedItems) {
                const parsed = JSON.parse(savedItems);
                const newFormat = {};
                let needsConversion = false;

                if (typeof parsed['item-0'] === 'string' || (typeof parsed['item-0'] === 'object' && parsed['item-0'] !== null && parsed['item-0'].hasOwnProperty('icon'))) {
                    needsConversion = true;
                }

                if (needsConversion) {
                    for (const key in parsed) {
                        if (parsed.hasOwnProperty(key)) {
                            newFormat[key] = {
                                text: typeof parsed[key] === 'string' ? parsed[key] : (parsed[key].text || ''),
                                completed: false 
                            };
                        }
                    }
                    return newFormat;
                }
                return parsed;
            }
            return {};
        }

        // Fonction pour créer une case de la grille
        function createGridItem(index, content = {text: '', completed: false}) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('grid-item');
            itemDiv.dataset.index = index;

            const statusButton = document.createElement('div');
            statusButton.classList.add('status-button');
            if (content.completed) {
                statusButton.classList.add('completed');
            }
            statusButton.addEventListener('click', (event) => {
                event.stopPropagation();
                statusButton.classList.toggle('completed');
                saveGridContent();
            });
            itemDiv.appendChild(statusButton);

            const textarea = document.createElement('textarea');
            textarea.value = content.text;
            textarea.setAttribute('rows', '3');
            textarea.setAttribute('maxlength', '200');
            textarea.setAttribute('placeholder', translations[currentLanguage]['Click to write...']);

            const placeholderSpan = document.createElement('span');
            placeholderSpan.classList.add('placeholder');
            placeholderSpan.textContent = translations[currentLanguage]['Click to write...'];

            const updateTextareaPlaceholder = (element) => {
                const text = element.value;
                const placeholder = element.nextElementSibling;
                if (text.trim() === '') {
                    placeholder.style.display = 'block';
                } else {
                    placeholder.style.display = 'none';
                }
            };
            
            textarea.addEventListener('input', () => {
                saveGridContent();
                updateTextareaPlaceholder(textarea);
            });

            textarea.addEventListener('focus', () => {
                itemDiv.classList.add('active');
                placeholderSpan.style.display = 'none';
            });

            textarea.addEventListener('blur', () => {
                itemDiv.classList.remove('active');
                saveGridContent();
                updateTextareaPlaceholder(textarea);
            });

            itemDiv.addEventListener('click', (event) => {
                if (!statusButton.contains(event.target)) {
                    textarea.focus();
                }
            });
            
            itemDiv.appendChild(textarea);
            itemDiv.appendChild(placeholderSpan);
            updateTextareaPlaceholder(textarea);

            return itemDiv;
        }
        
        function updateTextareaPlaceholder(textarea) {
            const placeholderSpan = textarea.nextElementSibling;
            if (textarea.value.trim() === '') {
                placeholderSpan.style.display = 'block';
            } else {
                placeholderSpan.style.display = 'none';
            }
        }

        clearGridButton.addEventListener('click', () => {
            const confirmationText = translations[currentLanguage]['Are you sure you want to clear the entire checklist? This action is irreversible.'];
            if (confirm(confirmationText)) {
                localStorage.removeItem('checklistGrid');
                initializeGrid();
            }
        });

        addItemButton.addEventListener('click', () => {
            const newIndex = gridContainer.children.length;
            const newItem = createGridItem(newIndex, {text: '', completed: false});
            gridContainer.appendChild(newItem);
            saveGridContent();
            newItem.querySelector('textarea').focus();
        });

        function initializeGrid() {
            gridContainer.innerHTML = '';
            const loadedItems = loadGridContent();
            
            const itemKeys = Object.keys(loadedItems).sort((a, b) => {
                const indexA = parseInt(a.split('-')[1]);
                const indexB = parseInt(b.split('-')[1]);
                return indexA - indexB;
            });

            const initialNumItems = Math.max(4, itemKeys.length);

            for (let i = 0; i < initialNumItems; i++) {
                const content = loadedItems[`item-${i}`] || {text: '', completed: false};
                gridContainer.appendChild(createGridItem(i, content));
            }
        }

        // Logique d'exportation JSON
        exportJsonButton.addEventListener('click', () => {
            const itemsToExport = {};
            document.querySelectorAll('.grid-item').forEach((itemDiv, index) => {
                const textarea = itemDiv.querySelector('textarea');
                const isCompleted = itemDiv.querySelector('.status-button').classList.contains('completed');
                if (textarea.value.trim() !== '' || isCompleted) {
                    itemsToExport[`item-${index}`] = {
                        text: textarea.value,
                        completed: isCompleted
                    };
                }
            });

            const jsonString = JSON.stringify(itemsToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checklist.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Logique d'importation JSON
        importJsonButton.addEventListener('click', () => {
            jsonFileInput.click();
        });

        jsonFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            const confirmationText = translations[currentLanguage]['Importing a JSON file will replace the current checklist. Do you want to continue?'];
            if (!confirm(confirmationText)) {
                jsonFileInput.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedItems = JSON.parse(e.target.result);
                    localStorage.removeItem('checklistGrid'); 
                    localStorage.setItem('checklistGrid', JSON.stringify(importedItems));
                    
                    initializeGrid();
                    alert(translations[currentLanguage]['Checklist imported successfully!']);

                } catch (error) {
                    console.error("Erreur lors de l'importation du JSON:", error);
                    alert(translations[currentLanguage]["Error importing file. Make sure it's a valid JSON."]);
                } finally {
                    jsonFileInput.value = ''; 
                }
            };
            reader.readAsText(file);
        });

        // NOUVEAU: Logique d'exportation PNG
        exportPngButton.addEventListener('click', () => {
            document.querySelectorAll('.grid-item').forEach(item => {
                item.style.cursor = 'default';
            });
             document.querySelectorAll('textarea').forEach(textarea => {
                textarea.style.cursor = 'default';
            });


            html2canvas(checklistContainer, { 
                scale: 2,
                useCORS: true,
                backgroundColor: null
            }).then(canvas => {
                document.querySelectorAll('.grid-item').forEach(item => {
                    item.style.cursor = 'pointer';
                });
                document.querySelectorAll('textarea').forEach(textarea => {
                    textarea.style.cursor = 'text';
                });

                const link = document.createElement('a');
                link.download = 'checklist.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error("Erreur lors de l'exportation en PNG:", error);
                alert(translations[currentLanguage]['Unable to export to PNG. An error occurred.']);
                 document.querySelectorAll('.grid-item').forEach(item => {
                    item.style.cursor = 'pointer';
                });
                document.querySelectorAll('textarea').forEach(textarea => {
                    textarea.style.cursor = 'text';
                });
            });
        });


        document.addEventListener('DOMContentLoaded', () => {
            initializeGrid();
            translatePage(); // Initial call to set default language to English
            currentLanguage = 'en';
            
            // Initial setup for the button
            const flagIcon = document.getElementById('flag-icon');
            flagIcon.src = 'https://raw.githubusercontent.com/Tristanox/Tristanox-tools/refs/heads/Thumbnails/France-flag.png';
            flagIcon.alt = 'Traduire en Français';
            document.documentElement.lang = 'en';

            document.getElementById('page-title').innerText = translations.en['page-title'];

            document.querySelectorAll('[data-en]').forEach(element => {
                const text = element.dataset.en;
                if (text) {
                    element.innerText = text;
                }
            });

            document.querySelectorAll('.grid-item textarea').forEach(textarea => {
                textarea.setAttribute('placeholder', translations.en['Click to write...']);
                updateTextareaPlaceholder(textarea);
            });
        });
    </script>
</body>
</html>
